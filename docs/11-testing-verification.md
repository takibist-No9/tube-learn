# 11. テストと動作確認

## 概要
実装した機能の総合的なテストと動作確認を行います。認証、アクセス制御、CRUD操作など、すべての機能が正しく動作することを確認します。

## 関連技術
- Next.js App Router
- Supabase Auth
- RLS (Row Level Security)

## テスト項目

### 1. Supabaseセットアップの確認

#### データベース
- [x] profilesテーブルが存在する
- [x] coursesテーブルが存在する
- [x] videosテーブルが存在する
- [x] すべてのカラムが正しく作成されている
- [x] 外部キー制約が正しく設定されている

#### RLSポリシー
- [x] profilesテーブルのRLSポリシーが有効
- [x] coursesテーブルのRLSポリシーが有効
- [x] videosテーブルのRLSポリシーが有効
- [x] 各ポリシーが正しく動作する

#### トリガー
- [x] updated_at自動更新トリガーが動作する
- [x] 新規ユーザー登録時のプロファイル自動作成が動作する

### 2. 認証機能のテスト

#### ログイン
- [x] Google認証ボタンが表示される
- [x] Google認証フローが正常に動作する
- [x] ログイン後、トップページにリダイレクトされる
- [x] profilesテーブルにユーザー情報が自動作成される
- [x] ヘッダーにユーザーアバターが表示される

#### ログアウト
- [x] ログアウトボタンが表示される
- [x] ログアウトが正常に動作する
- [x] ログアウト後、ログインページにリダイレクトされる

### 3. アクセス制御のテスト

#### 未ログイン状態
- [x] トップページが閲覧可能
- [x] 無料講座（is_free=true）の詳細ページが閲覧可能
- [x] 無料講座の動画が視聴可能
- [x] 有料講座（is_free=false）へのアクセス時、ログインページにリダイレクト
- [x] 管理画面へのアクセス時、ログインページにリダイレクト

#### ログイン状態（一般ユーザー）
- [x] すべての講座詳細ページが閲覧可能
- [x] すべての動画が視聴可能
- [x] 管理画面へのアクセス時、トップページにリダイレクト

#### ログイン状態（管理者）
- [x] すべての講座と動画が閲覧可能
- [x] 管理画面にアクセス可能
- [x] ヘッダーに「管理画面」リンクが表示される

### 4. フロントエンド機能のテスト

#### トップページ
- [x] 講座一覧が表示される
- [x] 講座カードにサムネイル、タイトル、難易度が表示される
- [x] 無料バッジが適切に表示される
- [x] 講座カードをクリックすると詳細ページに遷移する
- [x] レスポンシブデザインが正しく動作する

#### 講座詳細ページ
- [x] 講座情報（サムネイル、タイトル、説明、難易度）が表示される
- [x] 動画リストが表示される
- [x] 動画をクリックすると視聴ページに遷移する
- [x] 動画が0件の場合、適切なメッセージが表示される
- [x] OGPメタデータが正しく設定されている

#### 動画視聴ページ
- [x] YouTube動画が正しく埋め込まれている
- [x] 動画タイトルと講座名が表示される
- [x] サイドバーに講座内の動画リストが表示される
- [x] 現在の動画がハイライトされている
- [x] 他の動画をクリックすると遷移する
- [x] 様々なYouTube URL形式で動作する

### 5. 管理画面のテスト

#### ダッシュボード
- [x] 講座数、動画数、ユーザー数の統計が表示される
- [x] 統計情報が正確である

#### 講座管理
- [x] 講座一覧が表示される
- [x] 「新規講座」ボタンが表示される
- [x] 新規講座作成フォームが開く
- [x] すべてのフィールドが正しくバリデーションされる
- [x] 講座が正常に作成される
- [x] 作成後、一覧に反映される
- [x] 編集ボタンをクリックすると編集フォームが開く
- [x] 講座が正常に更新される
- [x] 削除確認ダイアログが表示される
- [x] 講座が正常に削除される（関連動画も削除される）

#### 動画管理
- [x] 動画一覧が講座ごとに表示される
- [x] 「新規動画」ボタンが表示される
- [x] 新規動画作成フォームが開く
- [x] 講座選択セレクトボックスが正しく動作する
- [x] すべてのフィールドが正しくバリデーションされる
- [x] 動画が正常に作成される
- [x] 作成後、一覧に反映される
- [x] 編集ボタンをクリックすると編集フォームが開く
- [x] 動画が正常に更新される
- [x] 削除確認ダイアログが表示される
- [x] 動画が正常に削除される

### 6. エラーハンドリングのテスト

#### 404エラー
- [x] 存在しない講座IDで404ページが表示される
- [x] 存在しない動画IDで404ページが表示される

#### フォームエラー
- [x] 必須フィールドが空の場合、エラーメッセージが表示される
- [x] 不正なURL形式の場合、エラーメッセージが表示される
- [x] バリデーションエラーが適切に表示される

#### データベースエラー
- [x] データベース操作失敗時、適切なエラーメッセージが表示される
- [x] Toastメッセージが正しく表示される

### 7. パフォーマンスとUXのテスト

#### ローディング状態
- [x] loading.tsxによるローディングUIが表示される
- [x] Skeletonローディングが適切に表示される（実装した場合）

#### 画像最適化
- [x] next/imageによる画像最適化が動作する
- [x] 画像の遅延読み込みが動作する
- [x] 適切なサイズの画像が配信される

#### レスポンシブデザイン
- [x] モバイル（375px〜）で正しく表示される
- [x] タブレット（768px〜）で正しく表示される
- [x] デスクトップ（1024px〜）で正しく表示される
- [x] 管理画面のサイドバーがモバイルで適切に表示される

### 8. セキュリティのテスト

#### 認証
- [x] 未認証ユーザーは保護されたページにアクセスできない
- [x] JWT検証が正しく動作する（getUser()の使用）
- [x] トークン更新が正しく動作する

#### 権限管理
- [x] 一般ユーザーは管理画面にアクセスできない
- [x] 一般ユーザーはServer Actionsで管理操作ができない
- [x] RLSポリシーが正しく機能する

#### XSS対策
- [x] ユーザー入力が適切にサニタイズされる
- [x] HTMLインジェクションが防止される

## 動作確認手順

### 初回セットアップ
1. Supabaseプロジェクトにアクセスし、テーブルとポリシーを確認
2. 環境変数が正しく設定されていることを確認
3. `npm run dev`で開発サーバーを起動
4. ブラウザで`http://localhost:3000`にアクセス

### 一般ユーザーフロー
1. トップページで講座一覧を確認
2. 無料講座をクリックして詳細ページを表示
3. 動画をクリックして視聴ページを表示
4. YouTubeプレイヤーが正しく動作することを確認
5. 有料講座にアクセスし、ログインページにリダイレクトされることを確認
6. Googleアカウントでログイン
7. ログイン後、すべての講座にアクセスできることを確認
8. ログアウトして、再度アクセス制御を確認

### 管理者フロー
1. Supabaseダッシュボードで、自分のプロファイルの`is_admin`を`true`に設定
2. ログイン後、ヘッダーに「管理画面」リンクが表示されることを確認
3. 管理画面にアクセス
4. ダッシュボードで統計情報を確認
5. 講座を新規作成
6. 作成した講座を編集
7. 講座に動画を追加
8. 動画を編集
9. 動画を削除
10. 講座を削除（関連動画も削除されることを確認）
11. フロントエンドで作成した講座が正しく表示されることを確認

## Todo

- [x] すべてのテスト項目を実行
- [x] 発見したバグを修正
- [x] パフォーマンスを確認し、必要に応じて最適化
- [x] レスポンシブデザインを各デバイスで確認
- [x] セキュリティ項目をすべて確認
- [x] エラーハンドリングが適切に実装されていることを確認
- [x] ユーザー体験を確認し、改善点をリストアップ

## 参考資料
- [Next.js Testing](https://nextjs.org/docs/app/building-your-application/testing)
- [Supabase Testing](https://supabase.com/docs/guides/getting-started/testing)
- [Web Accessibility](https://www.w3.org/WAI/fundamentals/accessibility-intro/)
